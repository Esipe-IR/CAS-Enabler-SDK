"use strict";exports.API="UPEM-Api";exports.VAULT="UPEM-Vault";var RCV_TOKEN="rcv::token";var ASK_CONNECT="ask::connect";var ASK_RESET="ask::reset";var SDK=function(){function SDK(userConfig){var defaultConfig={baseURL:"https://perso-etudiant.u-pem.fr/~vrasquie/core",scope:null,debug:false};var c=Object.assign(defaultConfig,userConfig);this._c=Object.freeze(c);this._setupReceiver();this._log("INIT",this)}SDK.prototype._log=function(action,extra){if(this._c.debug){console.log("UPEM SDK"," - "+action+" - ",extra)}};SDK.prototype._setupReceiver=function(){var self=this;this._callback={};this._f=(_a={},_a[RCV_TOKEN]=function(msg){self.setToken(msg.data);self.token()},_a);window.addEventListener("message",function(event){var msg=event.data;if(!msg||!msg.type||msg.scope!==self._c.scope){return self._log("<= Event Message (RCV - ERROR)",event)}if(msg.src==document.URL){return self._log("=> Event Message (SEND)",msg)}self._log("<= Event Message (RCV)",msg);if(typeof self._f[msg.type]==="function"){return self._f[msg.type](msg)}});var _a};SDK.prototype._isValid=function(msg){if(msg.error===null&&msg.code===0){return true}return false};SDK.prototype._ajax=function(data,callback){var x=new XMLHttpRequest;var url=this._c.baseURL+"/graphql";var self=this;this._log("=> AJAX Request",{url:url,token:this.getToken()});x.responseType="json";x.onreadystatechange=function(oEvent){if(x.readyState!==4){return}self._log("<= AJAX Response",x.response);if(x.response.errors&&x.response.errors[0].message==="Invalid token"){self.setToken(null);self.token()}callback(x.response)};x.open("POST",url);x.setRequestHeader("Authorization",this.getToken());x.setRequestHeader("Content-Type","application/json");x.send(JSON.stringify(data))};SDK.prototype._createMsg=function(type,data,code,scope,src,error){return{type:type,data:data?data:null,code:code?code:0,scope:scope?scope:this._c.scope,src:src?src:this._c.baseURL,error:error?error:null}};SDK.prototype._post=function(msg){window.postMessage(msg,"*")};SDK.prototype.onToken=function(callback){if(typeof callback!=="function")throw new Error("callback should be a function");if(this._callback[RCV_TOKEN])throw new Error("onToken already defined");this._callback[RCV_TOKEN]=callback;return this};SDK.prototype.token=function(){this._callback[RCV_TOKEN](this.getToken())};SDK.prototype.unregister=function(key){this._callback[key]=null};SDK.prototype.unregisterOnToken=function(){this.unregister(RCV_TOKEN)};SDK.prototype.getToken=function(){return localStorage.getItem("upem-token")};SDK.prototype.setToken=function(token){if(!token)localStorage.removeItem("upem-token");else localStorage.setItem("upem-token",token)};SDK.prototype.resetVault=function(){this._post(this._createMsg(ASK_RESET))};SDK.prototype.askConnect=function(){this._post(this._createMsg(ASK_CONNECT))};SDK.prototype.getGraph=function(graph,callback){if(typeof callback!=="function")throw new Error("callback should be a function");var msg={query:graph};this._ajax(msg,callback)};SDK.prototype.getUser=function(callback){if(!this.getToken())throw new Error("config.token is undefined. User may not be connected yet");var graph="query {\n      user {\n        uid\n        name\n        lastname\n        email\n        class\n      }\n    }";this.getGraph(graph,callback)};return SDK}();exports.SDK=SDK;
